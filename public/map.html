<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hunger Games Arena – Fixed</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
	body { margin: 0; overflow: hidden; background: black; }
	.label {
		position: absolute;
		color: #fff;
		font-size: 12px;
		pointer-events: none;
		transform: translate(-50%, -50%);
		text-shadow: 0 0 6px red;
	}
</style>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
  }
}
</script>
</head>

<body>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";
import { OBJLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/OBJLoader.js";

/* ======================
   RENDERER
====================== */

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
renderer.autoClear = false;
document.body.appendChild(renderer.domElement);

/* ======================
   SCENE / CAMERA
====================== */

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 1, 8000);
camera.position.set(0, 900, 1400);

/* ======================
   CONTROLS
====================== */

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

/* ======================
   LIGHTING
====================== */

scene.add(new THREE.AmbientLight(0x666666));
const sun = new THREE.DirectionalLight(0xffffff, 1.2);
sun.position.set(800, 1500, 600);
scene.add(sun);

/* ======================
   ARENA
====================== */

new OBJLoader().load("./arena.obj", obj => {
	obj.traverse(m => {
		if (m.isMesh) {
			m.material = new THREE.MeshStandardMaterial({
				color: 0x1a1a1a,
				roughness: 0.9
			});
		}
	});
	scene.add(obj);
});

/* ======================
   PLAYER MARKERS (RESTORED)
====================== */

const markers = [];

function addMarker(x, z) {
	const m = new THREE.Mesh(
		new THREE.SphereGeometry(12, 16, 16),
		new THREE.MeshBasicMaterial({ color: 0xff3333 })
	);
	m.position.set(x, 15, z);
	scene.add(m);
	markers.push(m);
}

// demo markers
addMarker(100, 100);
addMarker(-200, -50);
addMarker(0, -300);

/* ======================
   PROJECTION OVERLAY SHADER
====================== */

const projectionMaterial = new THREE.ShaderMaterial({
	uniforms: {
		uTime: { value: 0 }
	},
	vertexShader: `
		void main() {
			gl_Position = vec4(position, 1.0);
		}
	`,
	fragmentShader: `
		uniform float uTime;

		float rand(vec2 p) {
			return fract(sin(dot(p, vec2(12.9898,78.233))) * 43758.5453);
		}

		void main() {
			vec2 uv = gl_FragCoord.xy / vec2(${innerWidth.toFixed(1)}, ${innerHeight.toFixed(1)});
			float scan = sin((uv.y + uTime*0.1) * 400.0) * 0.04;
			float flicker = rand(uv + uTime) * 0.05;
			vec3 col = vec3(0.0, 0.3, 0.8) * (scan + flicker);
			gl_FragColor = vec4(col, 0.35);
		}
	`,
	transparent: true,
	depthWrite: false
});

const overlayScene = new THREE.Scene();
const overlayCam = new THREE.OrthographicCamera(-1,1,1,-1,0,1);
overlayScene.add(new THREE.Mesh(
	new THREE.PlaneGeometry(2,2),
	projectionMaterial
));

/* ======================
   ANIMATE
====================== */

function animate() {
	projectionMaterial.uniforms.uTime.value = performance.now() * 0.001;
	controls.update();

	renderer.clear();
	renderer.render(scene, camera);          // ✅ arena + markers
	renderer.render(overlayScene, overlayCam); // ✅ projection overlay
}
renderer.setAnimationLoop(animate);

/* ======================
   RESIZE
====================== */

window.addEventListener("resize", () => {
	camera.aspect = innerWidth / innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(innerWidth, innerHeight);
});
</script>

</body>
</html>
