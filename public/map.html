<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hunger Games Arena Map</title>

<style>
	body {
		margin: 0;
		overflow: hidden;
		background: radial-gradient(#050505, #000);
		font-family: Arial, sans-serif;
	}

	.label {
		position: absolute;
		color: #fff;
		font-size: 12px;
		text-align: center;
		pointer-events: none;
		transform: translate(-50%, -50%);
		text-shadow: 0 0 6px #ff4444;
		opacity: 0.75;
	}

	.label.selected {
		font-size: 14px;
		opacity: 1;
		text-shadow:
			0 0 8px #ffaaaa,
			0 0 16px #ff0000;
	}
</style>
</head>

<body>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";
import { OBJLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/OBJLoader.js";

/* ======================
   SCENE
====================== */

const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x000000, 800, 4000);

const camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 1, 8000);
camera.position.set(0, 900, 1400);

/* ======================
   RENDERER
====================== */

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

/* ======================
   CONTROLS
====================== */

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.screenSpacePanning = true;
controls.minDistance = 400;
controls.maxDistance = 3000;
controls.maxPolarAngle = Math.PI / 2.1;

/* ======================
   LIGHTING
====================== */

scene.add(new THREE.AmbientLight(0x666666));

const sun = new THREE.DirectionalLight(0xffffff, 1.2);
sun.position.set(800, 1500, 600);
scene.add(sun);

/* ======================
   ARENA OBJ
====================== */

new OBJLoader().load("./arena.obj", obj => {
	obj.traverse(m => {
		if (m.isMesh) {
			m.material = new THREE.MeshStandardMaterial({
				color: 0x2a2a2a,
				roughness: 0.8,
				metalness: 0.2
			});
		}
	});
	obj.scale.set(20, 20, 20);
	scene.add(obj);
});

/* ======================
   PLAYER MARKERS
====================== */

const markers = new Map();
const clickable = [];

let selected = null;

function createMarker(player) {
	const group = new THREE.Group();

	/* Core */
	const core = new THREE.Mesh(
		new THREE.SphereGeometry(10, 16, 16),
		new THREE.MeshBasicMaterial({ color: 0xff3333 })
	);
	group.add(core);

	/* Glow */
	const glow = new THREE.Mesh(
		new THREE.SphereGeometry(18, 16, 16),
		new THREE.MeshBasicMaterial({
			color: 0xff0000,
			transparent: true,
			opacity: 0.35
		})
	);
	group.add(glow);

	/* Selection ring */
	const ring = new THREE.Mesh(
		new THREE.RingGeometry(22, 28, 32),
		new THREE.MeshBasicMaterial({
			color: 0xffffaa,
			side: THREE.DoubleSide,
			transparent: true,
			opacity: 0
		})
	);
	ring.rotation.x = -Math.PI / 2;
	group.add(ring);

	group.userData.userId = player.userId;
	clickable.push(core);

	const label = document.createElement("div");
	label.className = "label";
	label.innerHTML = `<b>D${player.district}</b><br>${player.name}`;
	document.body.appendChild(label);

	scene.add(group);
	markers.set(player.userId, { group, core, glow, ring, label });
}

/* ======================
   SELECTION LOGIC
====================== */

const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

function selectMarker(userId) {
	if (selected && markers.has(selected)) {
		const prev = markers.get(selected);
		prev.ring.material.opacity = 0;
		prev.label.classList.remove("selected");
	}

	selected = userId;

	if (markers.has(userId)) {
		const m = markers.get(userId);
		m.ring.material.opacity = 0.8;
		m.label.classList.add("selected");
	}
}

window.addEventListener("click", e => {
	mouse.x = (e.clientX / innerWidth) * 2 - 1;
	mouse.y = -(e.clientY / innerHeight) * 2 + 1;

	raycaster.setFromCamera(mouse, camera);
	const hits = raycaster.intersectObjects(clickable);

	if (hits.length) {
		selectMarker(hits[0].object.parent.userData.userId);
	} else {
		selectMarker(null);
	}
});

/* ======================
   UPDATE PLAYERS
====================== */

async function updatePlayers() {
	const res = await fetch("/map");
	const players = await res.json();

	for (const p of players) {
		if (!markers.has(p.userId)) createMarker(p);

		const { group, label } = markers.get(p.userId);
		group.position.set(p.x, 15, p.z);

		const screenPos = group.position.clone().project(camera);
		label.style.left = ((screenPos.x + 1) / 2 * innerWidth) + "px";
		label.style.top = ((-screenPos.y + 1) / 2 * innerHeight) + "px";
	}
}

/* ======================
   ANIMATE
====================== */

function animate() {
	controls.update();

	const pulse = 1 + Math.sin(Date.now() * 0.004) * 0.25;
	for (const m of markers.values()) {
		m.glow.scale.set(pulse, pulse, pulse);
	}

	renderer.render(scene, camera);
}

/* ======================
   RESIZE
====================== */

window.addEventListener("resize", () => {
	camera.aspect = innerWidth / innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(innerWidth, innerHeight);
});

/* ======================
   START
====================== */

setInterval(updatePlayers, 250);
renderer.setAnimationLoop(animate);
</script>

</body>
</html>
