<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dead Tributes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
	body { margin:0; overflow:hidden; background:#111; font-family:system-ui,sans-serif; }
	canvas { display:block; }

	.ui {
		position:absolute;
		color:white;
		font-family:system-ui,sans-serif;
		background:rgba(20,20,20,.65);
		backdrop-filter: blur(6px);
		border:1px solid rgba(255,255,255,.1);
		border-radius:8px;
		padding:8px;
		font-size:12px;
	}

	.nameTag {
		color:white;
		text-align:center;
		margin-top:-20px;
		font-size:14px;
		font-weight:bold;
		text-shadow: 0 0 5px black;
	}
</style>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
  }
}
</script>
</head>
<body>
<script type="module">
import * as THREE from "three";

/* ======================
   RENDERER / SCENE
====================== */
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x111111);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 1, 10000);
camera.position.set(0, 400, 800);

/* ======================
   LIGHTING
====================== */
scene.add(new THREE.AmbientLight(0xffffff,0.5));
const sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(500,800,500);
scene.add(sun);

/* ======================
   UI
====================== */
const tributeUI = document.createElement("div");
tributeUI.className = "ui";
tributeUI.style.top = "10px";
tributeUI.style.left = "10px";
tributeUI.innerHTML = "<b>Dead Tributes</b>";
document.body.appendChild(tributeUI);

/* ======================
   DEAD PLAYER GROUP
====================== */
const group = new THREE.Group();
scene.add(group);
const deadPlayers = new Map();

/* ======================
   MAKE BUST
====================== */
function makeBust(name) {
	const m = new THREE.Group();

	const head = new THREE.Mesh(
		new THREE.SphereGeometry(20, 16, 16),
		new THREE.MeshStandardMaterial({ color:0xff5555 })
	);
	head.position.y = 30;
	m.add(head);

	const arrow = new THREE.Mesh(
		new THREE.ConeGeometry(6,15,8),
		new THREE.MeshStandardMaterial({ color:0xffff00 })
	);
	arrow.rotation.x = Math.PI/2;
	arrow.position.y = 55;
	m.add(arrow);

	const label = document.createElement("div");
	label.className = "nameTag";
	label.textContent = name;
	document.body.appendChild(label);

	m.userData = { label };
	return m;
}

/* ======================
   FETCH DEAD PLAYERS
====================== */
async function updateDead() {
	const players = await fetch("/map").then(r=>r.json());
	const kills = await fetch("/kills").then(r=>r.json());

	const deadIds = new Set(kills.map(k => k.victim));

	let i = 0;
	const spacingX = 120;
	const spacingZ = 120;
	for(const k of kills){
		const id = k.victim;
		if(!deadIds.has(id)) continue;
		if(deadPlayers.has(id)) continue;

		const name = k.victim;
		const bust = makeBust(name);
		bust.position.set((i%5)*spacingX - 2*spacingX,0,Math.floor(i/5)*-spacingZ);
		group.add(bust);
		deadPlayers.set(id,bust);
		i++;
	}
}
setInterval(updateDead,2000);

/* ======================
   ANIMATE
====================== */
function animate() {
	requestAnimationFrame(animate);

	// Rotate group slowly
	group.rotation.y += 0.002;

	// Update label positions
	for(const bust of group.children){
		const pos = bust.position.clone();
		pos.project(camera);

		const x = (pos.x * 0.5 + 0.5) * window.innerWidth;
		const y = ( -pos.y * 0.5 + 0.5) * window.innerHeight;
		bust.userData.label.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
	}

	renderer.render(scene,camera);
}
animate();

/* ======================
   RESIZE
====================== */
window.addEventListener("resize",()=>{
	camera.aspect = window.innerWidth/window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
